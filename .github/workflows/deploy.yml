name: Deploy

on:
  push:
    branches: [ "main" ]

env:
  unit: bbgo

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go-version: [1.18.x]
        os: [linux]
        arch: [arm64]

    steps:
    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: ${{ matrix.go-version }}

    - name: Build
      run: |
        GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -o bbgo-${{ matrix.os }}-${{ matrix.arch }} ./cmd/bbgo
        mv bbgo-${{ matrix.os }}-${{ matrix.arch }} bbgo

    - uses: actions/upload-artifact@v3
      with:
        name: bbgo
        path: bbgo
        
  deploy:
    needs: build

    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v3

    - uses: actions/download-artifact@v3
      with:
        name: bbgo

    - name: Stop and disable service
      continue-on-error: true
      run: |
        sudo systemctl stop ${{ env.unit }}
        sudo systemctl disable ${{ env.unit }}
        sudo systemctl reset-failed ${{ env.unit }}

    - name: Copy files
      run: |
        mkdir -p ${{ vars.WORKSPACE }}
        cp -rf . ${{ vars.WORKSPACE }}

    - name: Start service
      working-directory: ${{ vars.WORKSPACE }}
      run: |
        chmod +x bbgo
        sudo systemd-run \
          --unit=${{ env.unit }} \
          --same-dir \
          -p Restart=always \
          -E MAX_API_KEY=${{ secrets.MAX_API_KEY }} \
          -E MAX_API_SECRET=${{ secrets.MAX_API_SECRET }} \
          -E HOME=${{ vars.WORKSPACE }} \
          ./bbgo run
